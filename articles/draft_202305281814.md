---
title: '[PostgreSQL] トランザクションをコミットせずにコネクションが切れた場合の挙動'
emoji: '🗂'
type: 'tech' # tech: 技術記事 / idea: アイデア
topics: ['postgresql', 'db']
published: false
---

## はじめに

データベースとの接続を切ったときに、終了していないトランザクションはどうなるのかが気になったので調べました。

## 検証

検証してみます。使用した PostgreSQL のバージョンは 14.8 です。

`psql` で `postgres` データベースに接続します。

```
$ psql -h localhost -p 5432 -U postgres -d postgres
psql (14.8 (Homebrew), server 14.6 (Debian 14.6-1.pgdg110+1))
Type "help" for help.
```

テーブルを作ってトランザクションを開始し、該当テーブルにレコードを INSERT してみます。

```
postgres=# CREATE TABLE users (
  id serial NOT NULL,
  name varchar(255) NOT NULL,
  PRIMARY KEY(id)
);
postgres=# START TRANSACTION;
postgres=*# INSERT INTO users (name) VALUES ('user1'), ('user2'), ('user3');
postgres=*# SELECT * FROM users;
 id | name
----+-------
  1 | user1
  2 | user2
  3 | user3
```

トランザクションを終了せずに `psql` の接続を切ります。

```
postgres=#
\q
```

もう一度データベースに接続して、レコードを取得してみると INSERT されていないことが確認できます。

```
postgres=# select * from users;
 id | name
----+------
(0 rows)
```

今回クライアントには psql を使いましたが、使っている DB クライアントやドライバによっては接続の終了前に自動的にトランザクションをコミットする可能性があります。トランザクション途中の変更を意図せず永続化させないようにするには、接続を閉じる前は常に明示的にトランザクションをロールバックしておくようにすると良いかもしれません。

<!--
## AUTOCOMMIT について

PostgreSQL のトランザクション関連でググってみると `AUTOCOMMIT` という機能が見つかると思います。関連ページを貼っておきます。

https://www.postgresql.jp/docs/9.5/ecpg-sql-set-autocommit.html

https://qiita.com/shoheihagiwara/items/8f5a0487839e7ac0355e

PostgreSQL ECPG という拡張が提供するセッションごとの自動コミット動作の設定、とドキュメントに書かれています。これはサーバとして提供している機能ではなく、クライアント側の挙動によって実現されている機能のようです。

この `AUTOCOMMIT` を ON に設定した状態で、トランザクションを終了せずに接続を切ると、変更はコミットされるようです。→ されません

```
$ psql -h localhost -U postgres -d postgres
Password for user postgres:
psql (14.8 (Homebrew), server 14.6 (Debian 14.6-1.pgdg110+1))
Type "help" for help.

postgres=# select * from users;
 id | name
----+------
(0 rows)

postgres=# \echo :AUTOCOMMIT
on
postgres=# INSERT INTO users (name) VALUES ('user1'), ('user2'), ('user3');
INSERT 0 3
postgres=# select * from users;
 id | name
----+-------
  1 | user1
  2 | user2
  3 | user3
(3 rows)

postgres=#
\q

$ psql -h localhost -U postgres -d postgres
Password for user postgres:
psql (14.8 (Homebrew), server 14.6 (Debian 14.6-1.pgdg110+1))
Type "help" for help.

postgres=# select * from users;
 id | name
----+-------
 31 | user4
 32 | user5
 33 | user6
(3 rows)
```
-->

## 補足

正直当たり前の挙動でしょ、という感じがしたのですが DBMS によっては同じ挙動をしないようです。例えば Oracle DB のドキュメントには以下のような記載がありました。

> トランザクションは、次のいずれかの状況が発生すると終了します。
>
> - ...
> - ユーザーが Oracle Database の接続を切断する場合。カレント・トランザクションはコミットされます。

https://docs.oracle.com/cd/E15817_01/server.111/e05765/transact.htm

# 参考
