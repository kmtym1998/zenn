---
title: 'slog で Cloud Logging 向けのロガーを実装してみる'
emoji: '🦥'
type: 'tech' # tech: 技術記事 / idea: アイデア
topics: ['go', 'googlecloud', 'gcp']
published: false
---

# はじめに

最近 slog なるロガーパッケージがあることを知り、ちょっと使ってみたくなったので試しに API サーバの実装に組み込んでみました。自分は主に GCP 使うことが多いので [Cloud Logging](https://cloud.google.com/logging?hl=ja) でログを見ることを前提に実装しました。

# slog とは

<!-- textlint-disable ja-technical-writing/sentence-length -->

slog は構造化ログを出力するための Go の準標準パッケージです。Go で構造化ログを吐くためのライブラリだと [uber-go/zap](https://github.com/uber-go/zap) や [sirupsen/logrus](https://github.com/sirupsen/logrus) あたりが有名ですが、slog はそれらと比べ機能としては非常にシンプルな印象でした。

<!-- textlint-enable -->

基本的な使い方は以下の記事がわかりやすかったです。

https://zenn.dev/mizutani/articles/golang-exp-slog

上記の記事でも言及されている通り、slog は Go の標準パッケージとして提案されており、本記事の執筆現在も以下の issue でやり取りが行われています。

https://github.com/golang/go/issues/56345

## 準標準パッケージ exp

slog は記事を執筆している現在は Go の準標準パッケージの [exp](https://pkg.go.dev/golang.org/x/exp) パッケージに含まれています。「準標準パッケージ」と呼ばれる [golang.org/x](https://pkg.go.dev/golang.org/x) はいくつかのサブパッケージから成り立つ Go の公式パッケージです。その中でも slog が含まれる exp は準標準パッケージの中でも実験的なパッケージや非推奨のパッケージが含まれたものです。exp は Go 1 系のマイナーバージョンアップ時の後方互換性を約束しないことも明記されています[^1]。

[^1]: https://pkg.go.dev/golang.org/x/exp#section-readme

> In short, code in this subrepository is not subject to the Go 1 compatibility promise.

そのため、実際に slog (および exp) を import するときはこのことを念頭に、ライブラリを捨ててもアプリケーション側に致命傷を及ぼさないような作りにしておくのが良さそうです。

# 実装してみた内容の紹介

まだ slog が experimental だということは承知の上で API サーバに組み込んでみます。最終的には [Cloud Run](https://cloud.google.com/run/docs?hl=ja) へデプロイすることとします。

コードはこちらに置いておきましたので詳しく見たい方はご覧ください。試実装レベルのものなので、ディレクトリ構成やエラーハンドリング周りが少々雑なのはご了承ください。

https://github.com/kmtym1998/slog-gcp-example

以降はこちらの実装についての説明になります。

## slog のラッパーパッケージ

https://github.com/kmtym1998/slog-gcp-example/blob/cb34b1dd86d4f5a80c8e55c8bed65dc73ad33937/logger/logger.go

`slog.Logger` をラップしたパッケージです。`NewJSONHandler` メソッドを使うことで構造化ログを JSON 形式で出力できます。`Logger` 構造体を New するときにオプションを渡しています。

`Level` は出力するログレベルの下限を指定します。slog ではログレベルが低い順に `DEBUG`、`INFO`、`WARN`、`ERROR` の 4 つが定義されています。

`OnError` にはエラーログを吐いたあとに実行される関数を渡しています。zap や logrus には、ログを吐いてからそのログレベルに応じた hook を登録できる機能が提供されており、そこに着想を得て作りました。ここでエラー通知サービスにエラーを送ったりするような動きをさせる想定で作りました。

`ReplaceAttr` には構造化ログの key / value を加工するための処理を関数として渡します。ここでは Cloud Logging の仕様[^2]に合わせて以下のように加工をしています。

- ログレベルのキー を `level` から `severity` に
- ログレベルの値 `WARN` を `WARNING` に
- ログの本文のキーを `message` に

[^2]: [出力する JSON のログと Cloud Logging に出力されるログのマッピングはこちらを参照](https://cloud.google.com/logging/docs/structured-logging?hl=ja#special-payload-fields)

## middleware でロガーにトレース ID を詰め込む

https://github.com/kmtym1998/slog-gcp-example/blob/cb34b1dd86d4f5a80c8e55c8bed65dc73ad33937/main.go#L50-L53

[go-chi/chi](https://github.com/go-chi/chi) を使ってミドルウェアを差し込んでいます。

https://github.com/kmtym1998/slog-gcp-example/blob/cb34b1dd86d4f5a80c8e55c8bed65dc73ad33937/middleware/logger_injector.go

ミドルウェアの中でトレース ID を抽出しています。Cloud Run では `X-Cloud-Trace-Context` というリクエストヘッダにトレース ID が含まれています。トレース ID はリクエストごとで一意になるよう割り振られた 32 文字の 16 進数の値です。<!-- textlint-disable ja-technical-writing/sentence-length -->取得したトレース ID は `logging.googleapis.com/trace` というキーに `projects/[プロジェクトID]/traces/[トレースID]` の形式で出力するようにしています。<!-- textlint-enable -->

## Cloud Logging 上だとこんな感じ

# まとめ

# 参考

https://tech.buysell-technologies.com/entry/2022/08/29/120000
