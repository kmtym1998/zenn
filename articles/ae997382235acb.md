---
title: 'Go の Cloud Functions でファイルの読み取りをするひと工夫必要だった'
emoji: '🔖'
type: 'tech' # tech: 技術記事 / idea: アイデア
topics: ['Go', 'GCP']
published: false
---

# 概要

- ランタイムが Go の Cloud Functions では、ソースコードが `./serverless_function_source_code` 配下にある
- buildpack を使えば同じ挙動を再現できる

# 経緯

Go で動く Cloud Functions の処理の中で、GCS に置くほどでもないような、読み取り専用の JSON データをソースコードと一緒に管理していました。ディレクトリ構成は下記のような感じです。

```sh
$ tree
├── hoge-function
│   ├── cmd
│   │   └── main.go
│   ├── function.go   # function の本体
│   ├── go.mod
│   ├── go.sum
│   └── static
│       └── hoge.json # 読み取りたい静的な JSON ファイル
```

functionframework を使ってローカル環境を動かしていたので、`cmd/main.go` がローカルでの関数を実行するためのエントリーポイントになっています。関数の処理は `function.go` にあります。

```go:function.go
func ReadFile(w http.ResponseWriter, r *http.Request) {
  b, err := os.ReadFile("static/hoge.json")
  if err != nil {
    log.Println(err)
  }
  log.Println("static json", string(b))
}
```

この処理をローカル環境で実行すると、当然ながら `static/hoge.json` の中身が出力されます。

これを Cloud Functions にデプロイして動かすと

![cloud-logging-error](https://storage.googleapis.com/zenn-user-upload/7b58fdc4e5e1-20220807.png)

そんなファイルないと言われてしまいました。

- ローカル環境では functionframework を使っていた
- GCS に置くほどでもない JSON データを Cloud Functions のソースと同じところにおいていた
- 普通に `os.ReadFile` したらそんなファイルないと言われた
- どう見てもパスが間違っているとかではない。ローカル環境では読み込めている。

# 原因

- ドキュメント を見てみた

https://cloud.google.com/functions/docs/concepts/execution-environment#memory-file-system

> 注: Cloud Functions 実行環境では、関数のソースコードのルート ディレクトリは作業ディレクトリ（.）になります。ただし、Go ランタイムの場合は、関数ランタイムのルート ディレクトリが ./serverless_function_source_code にある現在の作業ディレクトリの下になります。

- 😅 ...Go だけ不思議なディレクトリが切られてて、その配下にある
- Cloud Function の実行環境でディレクトリを読み取ったりしてみた。確かにある

# 対策

- 前提として、CF のローカル環境を建てるのにやり方が 2 つある
  - functionframework ← 筆者はこちらを採用。簡単なので。
  - buildpack を使う ← こっちはソースコードの変更のたびにコンテナをビルドして立ち上げ直さないといけないので開発体験がイマイチ。
- ローカル環境でも Cloud Functions の実行環境上でも動くようにするには
- functionsframework を使い続ける場合
  - パスを環境変数化する
  - 環境の違いを意識したコードが生まれてしまう。↑ の仕様を知らないとなぜこんなことをしているのかわかりにくい
  - メリットは手軽なこと。開発体験がよい

https://cloud.google.com/functions/docs/running/overview?hl=ja#choosing_an_abstraction_layer

- buildpack を使う
  - 同じように os.ReadFile したりしてみたら ./serverless_function_source_code にソースコードがあった。
  - 他のディレクトリ構成も Cloud Functions と同じだった。
  - ほかは知らんが、fs に関しては Cloud Functions と同じ環境だと言えるので、そこ向けに書いてあげればいい
  - CLoud Functions の実行環境との違いを意識しなくていい点はメリット
  - デメリットは開発体験がイマイチなこと

# ついでに

## fs の中身深ぼってみた

## 他の言語だとどうなの？

```

```
