---
title: '【Go】画像の幅・高さを変えずに容量を圧縮する'
emoji: '🌁'
type: 'tech' # tech: 技術記事 / idea: アイデア
topics: ['Go']
published: false
---

# はじめに

業務で携わっているプロジェクトで、ユーザがアップロードした画像の容量をサーバサイドで小さくしたい要件がありました。あまり経験のないことで、調べるなかでいろいろ学びがあったので記事に残します。

# アーキテクチャ

- GCP でやった話
  - GCS バケットへのオブジェクトファイナライズで Cloud Functions が発火
  - リサイズした画像を別のバケットへアップロード
    - バケットと Functions の無限ループが発生しないように注意
  - メモリはデフォルトの 256MB で十分
  - 最大インスタンス数注意
  - Go を採用しているのでこのあと紹介するサンプルコードも Go
- ターゲットとなるバケットには画像以外のファイルもアップロードされる可能性がある。
  - ファイルのメディアタイプを MIME Sniffing で見分ける
  - 画像圧縮のアルゴリズム上 jpeg, png も見分ける必要があった

# jpeg の圧縮

## 品質クオリティ

- jpeg を圧縮するときの

## 画像を圧縮するコード

# png の圧縮

## 圧縮レベル

- https://docs.grapecity.com/help/c1/winrt-xaml/winrtxaml_zip/C1.Xaml.Zip~C1.C1Zip.CompressionLevelEnum.html

## 画像を圧縮するコード

# まとめ
