---
title: 'Hasura へのコントリビュートをした'
emoji: '🦉'
type: 'tech' # tech: 技術記事 / idea: アイデア
topics: ['hasura', 'OSS', 'GraphQL']
published: false
---

# はじめに

以前から OSS へのコミットに興味があり挑戦してみたので、やったことを記事にして残すことにしました。対象は仕事でもプライベートでもお世話になっている [Hasura](https://github.com/hasura/graphql-engine) を選びました。ちょうど直したかった issue があったこともきっかけのひとつになりました。

# ウォーミングアップ

全く自分と同じような境遇の記事をたまたま見つけたので目を通しました。

https://qiita.com/sho-hata/items/9140710ad4e409e20854

いきなりコードの改修に手を出すのはハードルが高いと思ったので、はじめはコントリビュートのお作法を学ぶ目的でドキュメントの typo 修正からやってみました。この段階でコントリビューションガイドの確認などを行い PR の出し方を把握しました。その時のログはスクラップに残しています。

https://zenn.dev/kmtym1998/scraps/a503ad1cd447fc

PR はこちら。この修正は 1 日ほどでマージされました。

https://github.com/hasura/graphql-engine/pull/8897

# 修正対象の issue

本命の issue はこちらです。

https://github.com/hasura/graphql-engine/issues/8579

Hasura Console で Remote Schemas のパーミッションを保存した後に吐き出されるメタデータが間違っているというバグです。<!-- textlint-disable ja-technical-writing/sentence-length -->メタデータの中のあるロールに許可している GraphQL のスキーマの中から `schema { query: Query mutation: Mutation }` が無くなってしまい、この吐き出されたメタデータを適用すると Remote Schemas のパーミッションがされない状態となってしまいます。 <!-- textlint-enable -->

結構致命的な感じがしますが v2.6.0 以降で発生し放置されていました。Remote Schemas はよく使うのでこれは直したいです。issue のコメントや open な PR を見て、他にも同じバグを修正している人はいなさそうなことを確認して修正に取り掛かります。

# バグの原因調査

## Hasura の仕様を調査

バグの原因についての前提知識として Hasura の仕様について軽く説明をします。自分がコードを読んで解釈した部分も説明するので公式ドキュメント等に記載のない内容も含まれています。誤った説明があればご指摘ください。

Hasura は大きく分けて 3 つのコンポーネントに分かれています。

| コンポーネント       | 役割                                                                      |
| -------------------- | ------------------------------------------------------------------------- |
| Server (Haskell)     | GraphQL サーバ。DB スキーマから自動生成した API を提供する                |
| CLI (Go)             | metadata や migration の適用・削除、開発用の Console の立ち上げなどを行う |
| Console (JavaScript) | Hasura の管理画面。各種設定を編集・確認できる                             |

今回修正をしたのは CLI のバグだったため、CLI についてもう少し補足を入れます。
開発環境では `hasura console` コマンドを使って Hasura Console を立ち上げて作業をしますが、その際に実は 2 つサーバが立ち上がっています。1 つは Hasura Console (9695 番で立ち上がる方)、もう 1 つは Migrate API (9693 番で立ち上がる方) です。

<!-- textlint-disable ja-technical-writing/ja-no-mixed-period -->

:::message
「Migrate API」という呼び方はドキュメント等には記載がありませんでしたが、[ソースコード上での表記](https://github.com/hasura/graphql-engine/blob/f7409ef2eb21bc73f6e9e8a1dbcdda878f0d6db1/cli/commands/console.go#L46)にならって以後そのように表記します。
:::

<!-- textlint-enable -->

立ち上がった Console で Hasura のメタデータの変更を加える操作をすると、Console から Migrate API にリクエストが飛びます。Migrate API で Hasura が接続している DB にメタデータの変更を保存します。このときの保存先は Server から参照されているところとは別です。PostgreSQL では Hasura に接続されている DB に `hdb_catalog` というスキーマが作られており、その配下に適用されたメタデータを保存するテーブルが存在します。(このあたりの仕様は DBMS によって違いそうです。) メタデータが DB に保存されたらそれがローカルに YAML ファイルとしてエクスポートされます。

以上を踏まえて、Remote Schemas のパーミッションをローカルの Hasura Console で設定するフローを図にするとこんな感じです。

![](https://storage.googleapis.com/zenn-user-upload/bec3499dc1e1-20220921.png)

(`hasura console` コマンドで Console と Migrate API を立ち上げた状態で)

1. パーミッションの編集・更新
2. Console から Migrate API にパーミッションに関するデータを送る (ここはロール名やそのロールに対して許可する GraphQL スキーマを文字列にしたものが含まれます)
3. Migrate API が変更後のメタデータを DB に保存
4. 変更後のメタデータをローカルのメタデータにエクスポート

という流れになります。

## バグの原因

前置きが長かったので、修正対象のバグがどんなバグだったかもう一度確認します。(issue を再掲)

https://github.com/hasura/graphql-engine/issues/8579

パーミッションを保存したときロールに許可するスキーマから `schema { query: Query mutation: Mutation }` が消えてしまうことでした。これがどの段階で消えてしまうのか調査しました。

図の ① 〜 ④ の順にデータの流れを追ってゆき、どこで `schema { query: Query mutation: Mutation }` が欠落するのかを調べました。その結果、問題のありそうな箇所は図の ④ の箇所にあることがわかりました。コードでいうとこちら。

https://github.com/hasura/graphql-engine/blob/92f601587cda0c22f6f9779270087e0bbd02d88f/cli/internal/metadataobject/remoteschemas/remote_schemas.go#L105-L116

GraphQL のスキーマ文字列を読み込んでフォーマットしている処理です。

まずは Console から Migrate API に対して `schema { ~` が送られてきているか (図の ② の部分) を調べます。ローカルで Hasura を立ち上げて Remote Schemas のパーミッションを保存すると `POST localhost:9693/apis/migrate` に向けてリクエストをしていました。このリクエストの中身には `schema { ~` が含まれていました。

<!-- textlint-disable -->

:::details Console から送っているリクエストの中身

```js
{
  "name": "save_remote_schema_permission",
  "up": [
    {
      "type": "drop_remote_schema_permissions",
      "args": {
        "remote_schema": "rs-sample",
        "role": "user"
      }
    },
    {
      "type": "add_remote_schema_permissions",
      "args": {
        "remote_schema": "rs-sample",
        "role": "user",
        "definition": {
          // ↓ ほしいものがしっかり含まれているのでこのパラメータはおそらく正しい
          "schema": "schema{\n      query: Query\n      mutation: Mutation\n}\n \ntype Query{ ~(略"
        }
      }
    }
  ],
  "down": [
    {
      "type": "add_remote_schema_permissions",
      "args": {
        "remote_schema": "rs-sample",
        "role": "user",
        "definition": {
          "schema": "schema  { query: Query mutation: Mutation }\n\nscalar bigint ~(略"
        }
      }
    },
    {
      "type": "drop_remote_schema_permissions",
      "args": {
        "remote_schema": "rs-sample",
        "role": "user"
      }
    }
  ],
  "datasource": "default",
  "skip_execution": false
}
```

:::

<!-- textlint-enable -->

ここで Console のバグではなさそうだということはわかります。

続いて DB に保存するメタデータが正しいのか (図の ③ の部分) を調べます。

# 学びになったこと

- テストめっちゃある
- golden test
- バージョン担保のためのしくみ。docker コンテナをめちゃくちゃ立ち上げてる
