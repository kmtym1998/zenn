---
title: 'Cloud Run と Cloud Storage を使って月数円程度で API を運用する'
emoji: '⛳️'
type: 'tech' # tech: 技術記事 / idea: アイデア
topics: []
published: false
---

# はじめに

- 趣味で API を作っている
- Cloud Run と Cloud Storage を使って月数円程度で運用できている

# 全体構成

- アーキテクチャの図

# 実装

## Cloud Storage バケットの作成

- SQLite のデータベースファイルを保存するためのバケットを作成
- オブジェクトの名前は保存した unix timestamp などをつけておく

## アプリケーションの実装

- ここが一番大事です
- Go のアプリケーションを例に説明します
- サーバの立ち上げ時に GCS から SQLite ファイルをダウンロードして `/tmp` に保存する
- 保存したファイルパスを使って、`sql.DB` 構造体を作成
- サーバを立ち上げ
- サーバの終了時に `/tmp` に保存した SQLite ファイルを GCS にアップロードする
  - Cloud Run はサーバの終了時に SIGTERM を送ってくるので、Graceful Shutdown ができる
  - このとき、アプリケーションの終了を待つために `os.Signal` を使って待つ

## Dockerfile の準備

- Go のアプリケーションをビルドするやつ

## Cloud Run サービスの作成

- Dockerfile を使ってコンテナイメージをビルド
- コンテナイメージを Cloud Run にデプロイ
- サービスアカウントの権限を設定
  - SQLite ファイルがおいてあるバケットのオブジェクトの List と Get ができるようにする
- 最高インスタンス数を 1 に設定
  - 複数インスタンスが立ち上がるとデータの整合性が取れなくなってしまうため

## デプロイ

# おわりに
